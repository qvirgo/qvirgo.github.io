---
layout: post
title: 如何做系统设计建模
category: 技术总结
tags: 系统设计，建模
description: 如何做系统设计建模，主要围绕DB展开
---

作为一个软件开发工程师，在日常工作中，不可避免地要接触各种系统设计。随着工龄的增加，可能自己也要去设计系统。另一方面，面试时越senior的工程师，系统设计所占比例越大。针对这一情况，我最近也有些自己的思考，准备在这篇文章里面记录下自己是如何做系统设计的。

首先软件工程就是抽象，将我们大千世界各种实体、场景抽象成代码中可操控的对象。所以遇到系统设计，第一件事应该是建模。而建模我一般分为两步：第一步是建立实体，第二步是建立实体之间的关系。这里我选取电影院选座系统例子，讲讲具体建模的过程。

首先我们建立实体，这里的实体有四个: 观影人、影厅、座位和电影。针对每个实体，我们赋予它相应的属性。

* a. 观影人属性: 用户名、个人基本信息。
* b. 影厅属性: 几号影厅、有多少个座位、巨幕还是普通影幕。
* c. 座位属性: 几排几号、所属影厅。
* d. 电影属性: 片名、播放时间段。

然后我们建立实体之间的关系。从开电影院的人角度来看，需要做的是将各个影厅在每天各个时段都排上电影，以追求效益最大化。从观影人角度来看，首先需要找到自己想看的电影，然后选择电影放映时间段，然后根据电影和放映时间段选择影厅，最后根据影厅选择座位。所以这里的关系有以下三种：

* a. 观影人和座位的关系
* b. 座位与影厅的关系
* c. 影厅与电影的关系

其中a关系是从观影人的角度衍生出来，c关系是从开电影院人的角度衍生出来。b关系则是固定的，同时也是a与c的桥梁。观影人的最终目的是看电影，电影放映的最终目的就是给观影人看。

完成建模后，接下来我们要考虑的事情是将模型保存在数据库中，以便程序逻辑去记录操控，也就是我们说的增删改查。首先是数据库的选择，这里有SQL和NoSQL两种选择。这两种数据的区别如下:

* a. SQL更适合多对多的关系(也就是图关系)，NoSQL更适合一对多的关系(也就是key->value的关系)
* b. SQL更适合属性结构不变的模型，NoSQL则可以满足属性结构动态变化的模型(document-based存储)
* c. SQL满足事务的ACID特性，NoSQL则追求的是最终一致性(接受中间态)

针对电影院选座系统，首先模型之间的关系是交叉的，然后模型的属性是固定不变的，最后每一个操作都追求强一致性，不接受中间态(座位只能占用和非占用，电影只能是放映和非放映)。所以我们选择SQL数据库，下面我以MySQL为例，去讲解如何create tables。

我们已经确定了四个实体以及实体之间的三个关系，那么就创建七个表:

* Users (userId, username, gender, age)
* Rooms (roomId, rank, seats, type, **isProjecting**)
* Seats (seatId, row, col, room, **isTaken**)
* Movies (movieId, movieName, startTime, endTime) 
* User_Seat (orderId, userId, seatId)
* Room_Seat (roomId, seatId)
* Room_Movie (projectId, roomId, movieId)

这七个表中前四个表是实体表，后三个表是实体关系表。有了这七个表，我们就可以做各种增删改查操作，满足电影院场景的各种需求。

这里要注意实体表与实体关系表之间的联动，每次user_seat表增加一条记录，就意味着相应的seat isTaken字段是true，而电影放映完，isTaken又变为false。每次room_movie增加一条记录，就意味着相应的room isProjecting字段是true，而电影放映完，isProjecting则变为false。所以这里涉及到多表的联动，为了保证数据一致性，就需要用到事务，这也是为什么我们选择关系型数据库的原因。

对于一个不太忙的电影院，上述的设计可以达到要求。但是对于一个繁忙的电影院或者对于万达这种全国连锁的影院，就意味着用户量，用户看电影的请求量呈几何级增长。这时我们要面对的就是一个请求量大，高并发的读写系统。这时对设计的要求又不一样了。

首先我想讲的是数据的动静分离。针对上述四个实体表，我们可以看到大部分数据都是静态的，但少部分数据是动态变化的。影厅是否在放映isProjecting字段在true和false之间变化，座位是否被占用isTaken字段也在true和false之间变化。动态数据为了读写一致性，一般都会直接对数据库进行直接读写的操作，这时如果连带着静态数据，那么对带宽的要求，对数据库资源的消耗就会增加。如果我们将静态数据和动态数据分开，每次只更新动态数据，静态数据放在cache里面，不仅可以减少数据的消耗，还可以减少rt时间。

然后是数据的垂直分片。针对单个数据库实例，其资源是有限的 (磁盘，内存，核数等等)。像user_seat, room_movie这样的流水关系表数据是持续增长的，当数据量变大到单库无法承受时，就采取分库分表的策略。而且其他的表，相对来说，数据量增长比较缓慢，单库即可解决所有的问题。我们知道服务对于单库和分库分表的操作是有很大区别的，分库分表需要考虑到路由寻址，同时唯一键的生成方式也不一样(需要全局唯一)。针对这种情况，我们将单库表和分库分表分别放在不同的数据库中，也就是所谓的垂直分片。

以上就是我对系统设计场景建模的一些思考，思考点比较集中，都是围绕着数据库展开。







